<%# app/views/blockchain/index.html.erb %>

<style>
  body { font-family: sans-serif; margin: 2em; }
  h1, h2 { color: #333; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; word-break: break-all; }
  th { background-color: #f2f2f2; }
  .actions-container { margin-top: 30px; padding: 20px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9; }
  .btn { display: inline-block; text-decoration: none; color: white; padding: 10px 15px; border-radius: 5px; margin-right: 15px; }
  .btn-create { background-color: #007bff; }
  .btn-mine { background-color: #28a745; border: none; font-size: 1em; cursor: pointer; }
</style>

<h1>Minha Blockchain em Rails (com Banco de Dados)</h1>

<div class="actions-container">
  <h2>Ações da Blockchain</h2>
  
  <%= link_to 'Criar Nova Transação', new_ledger_transaction_path, class: 'btn btn-create' %>

  <%= form_with url: add_block_path, method: :post, data: { turbo: false } do |form| %>
    <%= form.submit "Minerar Bloco com Transações Pendentes", class: 'btn btn-mine' %>
  <% end %>

  <%# Adicione este novo link de validação %>
  <%= link_to 'Validar Cadeia', validate_chain_path, class: 'btn', style: 'background-color: #ffc107; color: black;' %>
</div>

<h2>Cadeia de Blocos Atual</h2>
<table>
  <thead>
    <tr>
      <th>Índice</th>
      <th>Timestamp</th>
      <th>Dados (Transações)</th>
      <th>Nonce</th>
      <th>Hash Anterior</th>
      <th>Hash</th>
    </tr>
  </thead>
<tbody>
    <% if @blocks.any? %>
      <% @blocks.reverse.each do |block| %>
        <tr>
          <td><%= block.index %></td>
          <td><%= block.timestamp %></td>

          <%# CÉLULA DE DADOS CORRIGIDA %>
          <td>
            <% if block.data == 'Bloco Gênesis' %>
              <%= block.data %>
            <% else %>
              <% begin %>
                <% transactions = JSON.parse(block.data) %>
                <% if transactions.any? %>
                  <ul style="margin: 0; padding-left: 15px;">
                    <% transactions.each do |tx| %>
                      <li>
                        <strong>De:</strong> <%= truncate_key(tx['sender']) %> | 
                        <strong>Para:</strong> <%= truncate_key(tx['recipient']) %> | 
                        <strong>Quantia:</strong> <%= tx['amount'] %>
                      </li>
                    <% end %>
                  </ul>
                <% else %>
                  Nenhuma transação neste bloco.
                <% end %>
              <% rescue JSON::ParserError %>
                Dados em formato inválido.
              <% end %>
            <% end %>
          </td>

          <td><%= block.nonce %></td>
          <td><%= block.previous_hash %></td>
          <td><%= block.block_hash %></td>
        </tr>
      <% end %>
    <% else %>
      <tr>
        <td colspan="6">Nenhum bloco foi minerado ainda.</td>
      </tr>
    <% end %>
  </tbody>
</table>